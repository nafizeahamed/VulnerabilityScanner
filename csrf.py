import requests
from bs4 import BeautifulSoup
import scanner
import urllib.parse as urlparse
session = requests.Session()


def find_relevant_actions(url, form):
    action_attribute = form.get('name', '')

    # Check for keywords related to relevant actions
    if 'password' in action_attribute.lower():
        print(f"Form on {url} has a password related action.")
        return True
    elif 'email' in action_attribute.lower():
        print(f"Form on {url} has an email related action.")
        return True
    else:
        return False

def detect_csrf(target_url):
    username = input("username:")
    password = input("password:")
    vuln_scan = scanner.Scanner(target_url, [])
    login_url = input("Enter the url of login page :")

    form = vuln_scan.extract_forms(login_url)[0]

    inputs_list = form.find_all("input")

    post_data = {}

    for Input in inputs_list:
        input_name = Input.get("name")
        input_type = Input.get("type")
        input_value = Input.get("value")

        if input_type == "text" or input_type == "username":
            input_value = username
        elif input_type == "password":
            input_value = password
        post_data[input_name] = input_value

    r = session.post(login_url, data=post_data)
    if r.status_code == 200:
        print("Logged in successfully!!")
    vuln_scan.crawl()
    check_cookie_based_session_handling = session.cookies

    for link in vuln_scan.target_links:

        response = session.get(link)
        parsed_html = BeautifulSoup(response.content, "lxml")
        forms = parsed_html.find_all("form")

        for form in forms:
            # Check if the form contains an anti-CSRF token
            csrf_token = form.find('input', {'name': 'csrf'})

            if not csrf_token and check_cookie_based_session_handling and find_relevant_actions(link, form):
                print("No CSRF Token!!!")
                print(f"CSRF vulnerability found in form {form} on {link}")


def main():
    url = input("Enter the url : ")
    detect_csrf(url)

if __name__ == '__main__':
    main()